# =============================================================================
# Nginx Configuration for Struts2 S2-045 Defense Lab
# =============================================================================
# Features:
# - Reverse proxy to Tomcat backend
# - Rate limiting (10 req/s per IP)
# - Request size limits (10MB body, 8KB headers)
# - WAF rules for suspicious Content-Type detection
# - Comprehensive access/error logging
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # =========================================================================
    # Logging Configuration
    # =========================================================================
    # Custom log format with request ID and security-relevant headers
    log_format security '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'req_id="$request_id" '
                        'content_type="$content_type" '
                        'content_length="$content_length" '
                        'upstream_status="$upstream_status" '
                        'request_time="$request_time"';

    access_log /var/log/nginx/access.log security;

    # =========================================================================
    # Performance Settings
    # =========================================================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # =========================================================================
    # Security Headers
    # =========================================================================
    server_tokens off;  # Hide nginx version

    # =========================================================================
    # Rate Limiting Zone
    # =========================================================================
    # 10 requests per second per IP, with burst of 20
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    limit_req_status 429;

    # =========================================================================
    # Request Size Limits
    # =========================================================================
    client_max_body_size 10m;           # Max upload size: 10MB
    client_body_buffer_size 128k;       # Buffer for client body
    client_header_buffer_size 1k;       # Buffer for headers
    large_client_header_buffers 4 8k;   # Large header buffer

    # =========================================================================
    # Upstream (Tomcat Backend)
    # =========================================================================
    upstream tomcat_backend {
        server app:8080;
        keepalive 32;
    }

    # =========================================================================
    # Include WAF Rules
    # =========================================================================
    include /etc/nginx/waf-rules.conf;

    # =========================================================================
    # Main Server Block
    # =========================================================================
    server {
        listen 80;
        server_name localhost;

        # Generate unique request ID for tracing
        set $request_uuid $request_id;

        # ---------------------------------------------------------------------
        # Rate Limiting
        # ---------------------------------------------------------------------
        limit_req zone=req_limit burst=20 nodelay;

        # ---------------------------------------------------------------------
        # Security Headers for Responses
        # ---------------------------------------------------------------------
        add_header X-Request-ID $request_uuid always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options DENY always;
        add_header X-XSS-Protection "1; mode=block" always;

        # ---------------------------------------------------------------------
        # WAF: Check Content-Type for S2-045 Attack Patterns
        # ---------------------------------------------------------------------
        # This runs the WAF check defined in waf-rules.conf
        # Blocks requests with suspicious Content-Type headers
        # ---------------------------------------------------------------------
        
        # Check for suspicious patterns in Content-Type header
        set $waf_block 0;
        
        # Pattern 1: OGNL-like expressions in Content-Type
        if ($content_type ~* "(\%\{|\$\{|\#\{)") {
            set $waf_block 1;
        }
        
        # Pattern 2: Java class references
        if ($content_type ~* "(java\.|javax\.|com\.opensymphony)") {
            set $waf_block 1;
        }
        
        # Pattern 3: Common OGNL keywords (without actual payload)
        if ($content_type ~* "(getRuntime|Runtime|ProcessBuilder|exec\(|cmd\.exe|/bin/)") {
            set $waf_block 1;
        }
        
        # Pattern 4: Multipart with unusual characters suggesting injection
        # Note: Semicolon (;) is normal in multipart headers, so we check for
        # suspicious characters AFTER the semicolon or in unusual positions
        if ($content_type ~* "multipart.*[^;][\'\"\`\|]") {
            set $waf_block 1;
        }
        # Also check for multiple semicolons or semicolons in suspicious contexts
        if ($content_type ~* "multipart.*;.*;.*[\'\"\`\|]") {
            set $waf_block 1;
        }
        
        # Pattern 5: Unicode/encoding tricks
        if ($content_type ~* "(%00|%0a|%0d|\\x00)") {
            set $waf_block 1;
        }

        # Block if WAF triggered
        if ($waf_block = 1) {
            set $waf_log "[WAF] Blocked suspicious Content-Type: $content_type - Request ID: $request_uuid";
            return 403 "Forbidden - Request blocked by security filter\n";
        }

        # ---------------------------------------------------------------------
        # Health Check Endpoint (lightweight, no proxy)
        # ---------------------------------------------------------------------
        location = /nginx-health {
            access_log off;
            return 200 "nginx OK\n";
            add_header Content-Type text/plain;
        }

        # ---------------------------------------------------------------------
        # Proxy to Tomcat Application
        # ---------------------------------------------------------------------
        location /struts-lab/ {
            # Pass request ID to backend for log correlation
            proxy_set_header X-Request-ID $request_uuid;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Preserve original Content-Type for logging
            proxy_set_header X-Original-Content-Type $content_type;

            # Proxy settings
            proxy_pass http://tomcat_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # ---------------------------------------------------------------------
        # Default: Deny all other paths
        # ---------------------------------------------------------------------
        location / {
            return 404 "Not Found\n";
        }

        # ---------------------------------------------------------------------
        # Error Pages
        # ---------------------------------------------------------------------
        error_page 429 /429.html;
        location = /429.html {
            internal;
            return 429 "Too Many Requests - Rate limit exceeded\n";
        }

        error_page 403 /403.html;
        location = /403.html {
            internal;
            return 403 "Forbidden - Access denied\n";
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            return 500 "Internal Server Error\n";
        }
    }
}

