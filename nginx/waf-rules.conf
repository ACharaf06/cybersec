# =============================================================================
# WAF Rules for S2-045 Attack Pattern Detection
# =============================================================================
# These rules detect PATTERNS associated with S2-045 attacks without
# containing any actual exploit payloads.
#
# S2-045 Attack Characteristics:
# - Malicious Content-Type headers with expression language syntax
# - Attempts to inject code via multipart boundary manipulation
# - Use of OGNL (Object-Graph Navigation Language) expressions
#
# Detection Strategy:
# - Block requests with expression language markers in headers
# - Block requests with suspicious encoding patterns
# - Log all blocked requests for analysis
# =============================================================================

# -----------------------------------------------------------------------------
# Map: Detect Suspicious User-Agent Patterns
# -----------------------------------------------------------------------------
# Some automated exploit tools have distinctive User-Agent signatures
map $http_user_agent $suspicious_ua {
    default 0;
    "~*python-requests" 0;        # Common but legitimate
    "~*curl" 0;                   # Common but legitimate  
    "~*struts-pwn" 1;             # Known exploit tool
    "~*strutsshock" 1;            # Known exploit tool
    "~*nikto" 1;                  # Vulnerability scanner
    "~*sqlmap" 1;                 # SQL injection tool
    "~*nmap" 1;                   # Network scanner
    "~*masscan" 1;                # Port scanner
    "~*nuclei" 1;                 # Vulnerability scanner
}

# -----------------------------------------------------------------------------
# Map: Detect Suspicious Content-Type Patterns
# -----------------------------------------------------------------------------
# S2-045 exploits abuse the Content-Type header to inject OGNL expressions
map $content_type $suspicious_content_type {
    default 0;
    
    # Expression language markers (${}, %{}, #{})
    "~*\%\{" 1;
    "~*\$\{" 1;
    "~*\#\{" 1;
    
    # Java package references
    "~*java\." 1;
    "~*javax\." 1;
    "~*com\.opensymphony" 1;
    "~*org\.apache\.struts" 1;
    
    # Runtime execution keywords (pattern matching only, not actual payload)
    "~*Runtime" 1;
    "~*ProcessBuilder" 1;
    "~*getClass" 1;
    "~*forName" 1;
    
    # Shell command patterns
    "~*/bin/bash" 1;
    "~*/bin/sh" 1;
    "~*cmd\.exe" 1;
    "~*powershell" 1;
    
    # Encoding tricks often used in exploits
    "~*%00" 1;
    "~*%0a" 1;
    "~*%0d" 1;
    "~*\\\\x" 1;
    
    # Nested/malformed multipart boundaries
    "~*multipart.*multipart" 1;
    "~*boundary.*boundary" 1;
}

# -----------------------------------------------------------------------------
# Map: Suspicious HTTP Methods
# -----------------------------------------------------------------------------
map $request_method $suspicious_method {
    default 0;
    "CONNECT" 1;
    "TRACE" 1;
    "TRACK" 1;
}

# -----------------------------------------------------------------------------
# Geo-blocking placeholder (disabled by default)
# -----------------------------------------------------------------------------
# Uncomment and configure if you want to restrict by geography
# geo $blocked_country {
#     default 0;
#     # Example: block specific IP ranges
#     # 192.168.0.0/16 1;
# }

# -----------------------------------------------------------------------------
# Request Rate Tracking for Anomaly Detection
# -----------------------------------------------------------------------------
# Track request patterns per IP for potential automated attack detection
# This is used by the main nginx.conf rate limiting configuration
# limit_req_zone defined in main config

